<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Inzozi Shop</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                
                <h1>Inzozi Shop</h1>
            </div>
            <nav>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="admin/login.html">Admin</a></li>
                    <li><a href="cart.html">Cart (<span id="cart-count">0</span>)</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <section class="hero">
            <h2>Inzozi Shop Checkout</h2>
            <p>Complete your purchase securely</p>
        </section>

        <section class="cart-container">
            <h2>Checkout</h2>
            <div id="order-summary">
                <h3>Order Summary</h3>
                <div id="cart-items-checkout">
                    <!-- Cart items will be loaded here by JavaScript -->
                </div>
                <div class="total">
                    Total: <span id="total-checkout">0 RWF</span>
                </div>
            </div>
            
            <div id="payment-section">
                <h3>Payment Method</h3>
                <div class="payment-option">
                    <input type="radio" id="momo" name="payment-method" value="momo" checked>
                    <label for="momo">MoMo Payment</label>
                </div>
                <div class="payment-option">
                    <input type="radio" id="credit-card" name="payment-method" value="credit-card">
                    <label for="credit-card">Credit Card</label>
                </div>
                
                <div id="momo-payment-form">
                    <h4>MoMo Payment Details</h4>
                    <div class="form-group">
                        <label for="momo-phone">Phone Number:</label>
                        <input type="tel" id="momo-phone" placeholder="Enter your MoMo phone number" value="">
                    </div>
                    <button class="checkout-btn" onclick="processMoMoPayment()">Initiate MoMo Payment</button>
                </div>
                
                <div id="credit-card-form" style="display: none;">
                    <h4>Credit Card Details</h4>
                    <div class="form-group">
                        <label for="card-number">Card Number:</label>
                        <input type="text" id="card-number" placeholder="1234 5678 9012 3456">
                    </div>
                    <div class="form-group">
                        <label for="expiry-date">Expiry Date:</label>
                        <input type="text" id="expiry-date" placeholder="MM/YY">
                    </div>
                    <div class="form-group">
                        <label for="cvv">CVV:</label>
                        <input type="text" id="cvv" placeholder="123">
                    </div>
                    <button class="checkout-btn" onclick="processCardPayment()">Process Card Payment</button>
                </div>
            </div>
            
            <div id="payment-status"></div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Inzozi Shop. All rights reserved.</p>
            <p style="margin-top: 10px; font-size: 0.9rem; opacity: 0.8;">Your trusted online marketplace for quality products</p>
        </div>
    </footer>

    <script src="script.js"></script>
    <script>
        // Conversion rate from USD to RWF (example rate: 1 USD = 1200 RWF)
        const USD_TO_RWF_RATE = 1200;
        
        // Toggle payment forms based on selection
        document.addEventListener('DOMContentLoaded', function() {
            // Load cart items for checkout
            renderCheckoutCart();
            
            // Set up payment method toggle
            const paymentMethods = document.querySelectorAll('input[name="payment-method"]');
            paymentMethods.forEach(method => {
                method.addEventListener('change', function() {
                    if (this.value === 'momo') {
                        document.getElementById('momo-payment-form').style.display = 'block';
                        document.getElementById('credit-card-form').style.display = 'none';
                    } else {
                        document.getElementById('momo-payment-form').style.display = 'none';
                        document.getElementById('credit-card-form').style.display = 'block';
                    }
                });
            });
        });
        
        // Render cart items for checkout
        function renderCheckoutCart() {
            const cartItems = document.getElementById('cart-items-checkout');
            const totalElement = document.getElementById('total-checkout');
            
            if (!cartItems) return;
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<p>Your cart is empty</p>';
                if (totalElement) totalElement.textContent = '0 RWF';
                return;
            }
            
            let total = 0;
            let cartHTML = '';
            
            cart.forEach((item, index) => {
                total += item.price;
                // Convert price to RWF
                const priceInRwf = (item.price * USD_TO_RWF_RATE).toFixed(0);
                cartHTML += `
                    <div class="cart-item">
                        <div class="item-details">
                            <h3>${item.name}</h3>
                            <p class="item-price">${priceInRwf} RWF</p>
                        </div>
                    </div>
                `;
            });
            
            cartItems.innerHTML = cartHTML;
            
            if (totalElement) {
                // Convert total to RWF
                const totalInRwf = (total * USD_TO_RWF_RATE).toFixed(0);
                totalElement.textContent = `${totalInRwf} RWF`;
            }
        }
        
        // Process MoMo payment
        function processMoMoPayment() {
            const phoneNumber = document.getElementById('momo-phone').value;
            
            if (!phoneNumber) {
                alert('Please enter your MoMo phone number');
                return;
            }
            
            // Get total in RWF
            const totalInRwf = document.getElementById('total-checkout').textContent.replace(' RWF', '');
            
            // Generate a unique order ID
            const orderId = 'ORDER_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
            
            // Show processing message
            const statusDiv = document.getElementById('payment-status');
            statusDiv.innerHTML = `
                <div style="background-color: #fff3cd; color: #856404; padding: 15px; border-radius: 5px; margin-top: 20px;">
                    <strong>Processing...</strong> Initiating MoMo payment for ${totalInRwf} RWF...
                </div>
            `;
            
            // Send payment request to our server
            fetch('http://localhost:3000/api/momo-payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    phoneNumber: phoneNumber,
                    amount: totalInRwf,
                    orderId: orderId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    statusDiv.innerHTML = `
                        <div style="background-color: #d4edda; color: #155724; padding: 15px; border-radius: 5px; margin-top: 20px;">
                            <strong>Payment Request Sent!</strong> Please check your phone for the MoMo payment prompt. Amount: ${totalInRwf} RWF
                        </div>
                    `;
                    
                    // Clear cart after successful payment request
                    cart = [];
                    localStorage.setItem('cart', JSON.stringify(cart));
                    updateCartCount();
                    
                    // Redirect to success page after a short delay
                    setTimeout(() => {
                        window.location.href = `payment-success.html?orderId=${data.orderId}&amount=${totalInRwf}`;
                    }, 3000);
                } else {
                    statusDiv.innerHTML = `
                        <div style="background-color: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin-top: 20px;">
                            <strong>Payment Request Failed!</strong> ${data.message}
                        </div>
                    `;
                    
                    // Redirect to error page after a short delay
                    setTimeout(() => {
                        const errorMessage = encodeURIComponent(data.message || 'Payment processing failed');
                        window.location.href = `payment-error.html?code=PAYMENT_FAILED&message=${errorMessage}`;
                    }, 3000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                statusDiv.innerHTML = `
                    <div style="background-color: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin-top: 20px;">
                        <strong>Connection Error!</strong> Unable to connect to payment server. Please try again later.
                    </div>
                `;
                
                // Redirect to error page after a short delay
                setTimeout(() => {
                    window.location.href = `payment-error.html?code=NETWORK_ERROR&message=Unable to connect to payment server`;
                }, 3000);
            });
        }
        
        // Process credit card payment
        function processCardPayment() {
            const cardNumber = document.getElementById('card-number').value;
            const expiryDate = document.getElementById('expiry-date').value;
            const cvv = document.getElementById('cvv').value;
            
            if (!cardNumber || !expiryDate || !cvv) {
                alert('Please fill in all credit card details');
                return;
            }
            
            // Get total in RWF
            const totalInRwf = document.getElementById('total-checkout').textContent.replace(' RWF', '');
            
            // Simulate card payment processing
            const statusDiv = document.getElementById('payment-status');
            statusDiv.innerHTML = `
                <div style="background-color: #d4edda; color: #155724; padding: 15px; border-radius: 5px; margin-top: 20px;">
                    <strong>Payment Successful!</strong> Your order of ${totalInRwf} RWF has been placed. Thank you for shopping with Styvo Business!
                </div>
            `;
            
            // Clear cart after successful payment
            cart = [];
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartCount();
        }
    </script>
</body>
</html>